<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
  <script src=https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.min.js></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.0.4/chance.min.js"></script>
  <script src="js/ng-lodash.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>AngularTracker</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body ng-app="myApp">
  <nav class="teal lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Logo</a>
      <ul class="right hide-on-med-and-down">
        <li><a href="#/">Projects</a></li>
        <li><a href="#/timer">Timer</a></li>
      </ul>

      <ul id="nav-mobile" class="side-nav">
        <li><a href="#">Navbar Link</a></li>
      </ul>
      <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
    </div>
  </nav>


  <div class="container">
    <div class="section">
      <div ng-view></div>
    </div>
  </div>
        <script>

        /**
         * You first need to create a formatting function to pad numbers to two digits…
         **/
        function twoDigits(d) {
            if(0 <= d && d < 10) return "0" + d.toString();
            if(-10 < d && d < 0) return "-0" + (-1*d).toString();
            return d.toString();
        }

        /**
         * …and then create the method to output the date string as desired.
         * Some people hate using prototypes this way, but if you are going
         * to apply this to more than one Date object, having it as a prototype
         * makes sense.
         **/
        // Date.prototype.toMysqlFormat = function() {
        //     return this.getUTCFullYear() + "-" + twoDigits(1 + this.getUTCMonth()) + "-" + twoDigits(this.getUTCDate()) + " " + twoDigits(this.getUTCHours()) + ":" + twoDigits(this.getUTCMinutes()) + ":" + twoDigits(this.getUTCSeconds());
        // };

        function mapAttributes( item ) {
          return Object.assign( {}, { id: item.id }, item.attributes );
        }

        function formatTimer( seconds ) {
          const minutes = Math.floor( seconds / 60 );
          seconds = seconds % 60;
          return twoDigits( minutes ) + ':' + twoDigits( seconds );
        }

        // Declare app
        var app = angular.module("myApp", ["ngRoute", 'ngLodash']);
        app.filter('formatTimer', function() {
          return formatTimer;
        });

        // Routing
        app.config(function($routeProvider) {
            $routeProvider
            .when("/", {
                templateUrl : "projects.html",
                controller : "projectsCtrl"
            })
            .when("/timer", {
                templateUrl : "timer.html",
                controller : "timerCtrl"
            });
        });

        // Projects controller
        app.controller("projectsCtrl", function ($scope, $http, lodash) {

          $scope.projects = [];
          $scope.name = chance.word();
          $scope.description = chance.sentence();
          // $scope.myCol = '#abc';

          $scope.createProject = function() {
            const { name, description } = $scope;
            $scope.name = chance.word();
            $scope.description = chance.sentence();
            
            $http.post("/api/v1/projects",
            { data: { attributes: { name, description } } } )
            .then(function(response) {
              const newProject = mapAttributes( response.data.data );
              $scope.projects.push( newProject );
            })
            .catch(err => {
              $scope.statustext = err;
            });
          }

          // Get existing projects
          $http.get("/api/v1/projects")
          .then(function(response) {
            $scope.projects = response.data.data.map( mapAttributes );
          })
          .catch(err => {
            $scope.statustext = err;
          } );

        });

        // Timer controller
        app.controller("timerCtrl", function ($scope, $http, lodash) {
          const DURATION = 1500;
          // const DURATION = 5;
          // const IDLE = 0;
          // const RUNNING = 1;
          // $scope.timerStatus = IDLE;
          $scope.timer = null;
          $scope.timeRemaining = 0;
          $scope.currentTimer = {};
          $scope.timers = [];
          $scope.projects = [];

          $scope.startTimer = function() {
            $scope.timeRemaining = DURATION;
            $scope.timer = setInterval( () => {
              $scope.$apply(function(){
                $scope.timeRemaining -= 1;
                if( $scope.timeRemaining === 0 ) {
                  clearInterval( $scope.timer );
                  $scope.timer = null;
                }
              });
            }, 1000 );

          }

          $scope.select = function( evt ) {
            var id = parseInt( $( evt.target ).attr( 'id' ).substr( 6 ), 10 );
            console.log( $scope.timers );
            var timer = lodash.find( $scope.timers, { id } );
            $scope.currentTimer = timer;
          }

          $scope.createPomodoro = function() {
            const type = "pomodoro";
            $scope.description = "enter description here";
            $scope.currentTimer = null;
            $scope.startTimer();

            $http.post("/api/v1/timers",
            { data: { attributes: { type } } } )
            .then(function(response) {
              $scope.currentTimer = mapAttributes( response.data.data );
              $scope.items.push( $scope.currentTimer );
            })
            .catch(err => {
              $scope.statustext = err;
            });
          }

          $scope.updatePomodoro = function() {

            $http.put("/api/v1/timers/" + $scope.currentTimer.id,
            { data: { attributes: { description: $scope.description } } } )
            .then(function(response) {
              $scope.currentTimer = Object.assign( 
                $scope.currentTimer,
                mapAttributes( response.data.data )
              );
            })
            .catch(err => {
              $scope.statustext = err;
            });
          }



          // Get existing projects
          $http.get("/api/v1/timers")
          .then(function(response) {
            $scope.timers = response.data.data.map( mapAttributes );
          })
          .catch(err => {
            $scope.statustext = err;
          } );

          // Get existing projects
          $http.get("/api/v1/projects")
          .then(function(response) {
            $scope.projects = response.data.data.map( mapAttributes );
          })
          .catch(err => {
            $scope.statustext = err;
          } );

        });

        </script>
    </div>

  </div>

  <footer class="page-footer purple">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">bhu</h5>
          <p class="grey-text text-lighten-4">Je suis un geek.</p>


        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Settings</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
         </ul>
        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 4</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Made by <a class="purple-text text-lighten-3" href="http://materializecss.com">Materialize</a>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>

  </body>
</html>
